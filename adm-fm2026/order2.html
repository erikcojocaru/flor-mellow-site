<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FlorMellow - Management Comenzi</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }
    .container{
      background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);
      max-width:560px;width:100%;overflow:hidden;
    }
    .header{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;padding:26px 24px;text-align:center;
    }
    .header h1{font-size:28px;margin-bottom:6px}
    .header p{opacity:.9;font-size:13px}
    .tabs{
      display:flex;gap:10px;justify-content:center;padding:12px;background:#f6f6fb;border-bottom:1px solid #eee;
    }
    .tabBtn{
      border:none;border-radius:10px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;cursor:pointer;
      padding:10px 14px;font-size:14px;font-weight:600;
      box-shadow:0 8px 20px rgba(102,126,234,.25);
      transition:transform .15s,opacity .15s;
      width:auto;
    }
    .tabBtn:hover{transform:translateY(-1px)}
    .tabBtn.dim{opacity:.82}
    .form-container{padding:22px 24px 26px}
    .login-container{padding:34px 24px;text-align:center}
    .login-logo{font-size:56px;margin-bottom:12px}
    h2{color:#333;margin-bottom:16px}
    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:7px;color:#333;font-weight:600;font-size:13px}
    input,select,textarea{
      width:100%;padding:12px 14px;border:2px solid #e0e0e0;border-radius:10px;
      font-size:14px;transition:border-color .2s;font-family:inherit;
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea}
    textarea{resize:vertical;min-height:78px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:600px){.row{grid-template-columns:1fr}}
    .btn{
      width:100%;padding:13px 14px;border:none;border-radius:10px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;font-size:15px;font-weight:700;cursor:pointer;
      transition:transform .15s,box-shadow .15s;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(102,126,234,.26)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
    .logout-btn{background:#dc3545;width:auto;padding:9px 14px;font-size:13px;margin-top:12px}
    .message{padding:12px;border-radius:10px;margin-bottom:14px;text-align:center;font-size:13px;display:none}
    .message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .hidden{display:none}
    .muted{color:#666;font-size:13px;padding:10px 0}
    .manageHeader{
      display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;
    }
    .manageHeader h3{margin:0;color:#333}
    .miniBtn{
      width:auto;padding:10px 12px;font-size:13px;font-weight:700;border-radius:10px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;border:none;cursor:pointer;
    }
    .orderCard{
      border:1px solid #eee;border-radius:14px;padding:12px;margin:10px 0;background:#fafafe;
    }
    .orderTop{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-bottom:8px;
    }
    .oid{font-weight:800;color:#333;font-size:13px}
    .meta{color:#666;font-size:12px;margin-top:2px;line-height:1.35}
    .pill{
      display:inline-block;padding:4px 8px;border-radius:999px;
      background:#eef; color:#334; font-size:11px; font-weight:700;
      margin-top:6px;
    }
    .cardRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .saveRow{display:flex;gap:10px;align-items:center;margin-top:10px}
    .saveBtn{
      flex:1;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      border:none;border-radius:10px;color:#fff;font-weight:800;padding:10px;cursor:pointer;
    }
    .saveBtn:disabled{opacity:.6;cursor:not-allowed}
    .smallInput{padding:10px 12px;font-size:13px}
    #productPreview{display:none;margin-top:-6px;margin-bottom:14px;padding:10px;border:1px solid #eee;border-radius:12px;background:#fafafe}
    #productPreviewImg{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid #eee;background:#fff}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸŒ¸ FlorMellow</h1>
      <p>Sistem de Management Comenzi</p>
    </div>

    <div class="tabs">
      <button type="button" class="tabBtn" id="tabNew">âž• ComandÄƒ nouÄƒ</button>
      <button type="button" class="tabBtn dim" id="tabManage">ðŸ“‹ Comenzi Ã®n lucru</button>
    </div>

    <div id="loginContainer" class="login-container">
      <div class="login-logo">ðŸ”’</div>
      <h2>Autentificare</h2>
      <div class="message error" id="loginError"></div>
      <form id="loginForm">
        <div class="form-group">
          <input type="password" id="loginPassword" placeholder="ParolÄƒ" required />
        </div>
        <button class="btn" type="submit">IntrÄƒ</button>
      </form>
      <p class="muted" style="margin-top:10px;">(Un singur password. Nu existÄƒ username.)</p>
    </div>

    <div id="appContainer" class="form-container hidden">
      <div class="message success" id="successMessage"></div>
      <div class="message error" id="errorMessage"></div>

      <div id="manageContainer" class="hidden">
        <div class="manageHeader">
          <h3>Comenzi Ã®n lucru</h3>
          <button type="button" class="miniBtn" id="refreshOrdersBtn">â†» Refresh</button>
        </div>

        <div class="row" style="margin-bottom:10px;">
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:12px;">CautÄƒ</label>
            <input class="smallInput" type="text" id="searchBox" placeholder="telefon / nume / produs / order_id">
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:12px;">Status</label>
            <select class="smallInput" id="statusFilter">
              <option value="">Toate (Ã®n lucru)</option>
              <option value="pending">ÃŽn AÈ™teptare</option>
              <option value="confirmed">Confirmat</option>
              <option value="preparing">ÃŽn PregÄƒtire</option>
              <option value="delivered">Livrat</option>
              <option value="cancelled">Anulat</option>
            </select>
          </div>
        </div>

        <div id="ordersList"></div>
        <button type="button" class="btn logout-btn" id="logoutBtn2">Deconectare</button>
      </div>

      <form id="orderForm">
        <div class="form-group">
          <label for="clientName">Nume Client *</label>
          <input type="text" id="clientName" required />
        </div>

        <div class="form-group">
          <label for="clientPhone">Telefon Client *</label>
          <input type="tel" id="clientPhone" placeholder="0712345678" required />
        </div>

        <div class="form-group">
          <label for="product">Produs *</label>
          <select id="product" required>
            <option value="">SelecteazÄƒ produsul...</option>
            <option value="Buchet Trandafiri">Buchet Trandafiri</option>
            <option value="Buchet Lalele">Buchet Lalele</option>
            <option value="Buchet Mixt">Buchet Mixt</option>
            <option value="Aranjament Floral">Aranjament Floral</option>
            <option value="CoÈ™ Cadou">CoÈ™ Cadou</option>
            <option value="Cutie CiocolatÄƒ">Cutie CiocolatÄƒ</option>
            <option value="Altele">Altele</option>
          </select>
        </div>

        <div id="productPreview">
          <div style="display:flex;gap:10px;align-items:center;">
            <img id="productPreviewImg" src="" alt="">
            <div style="flex:1;">
              <div id="productPreviewName" style="font-weight:700;color:#333;font-size:14px;line-height:1.2;"></div>
              <div id="productPreviewMeta" style="margin-top:4px;color:#666;font-size:12px;"></div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="size">MÄƒrime *</label>
            <select id="size" required>
              <option value="">Alege...</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="Event">Event</option>
            </select>
          </div>

          <div class="form-group">
            <label for="quantity">Cantitate *</label>
            <input type="number" id="quantity" min="1" step="1" value="1" required />
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="price">PreÈ› (RON) *</label>
            <input type="number" id="price" step="0.01" min="0" required />
          </div>

          <div class="form-group">
            <label for="deliveryDate">Data LivrÄƒrii *</label>
            <input type="date" id="deliveryDate" required />
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="status">Status *</label>
            <select id="status" required>
              <option value="pending">ÃŽn AÈ™teptare</option>
              <option value="confirmed">Confirmat</option>
              <option value="preparing">ÃŽn PregÄƒtire</option>
              <option value="delivered">Livrat</option>
              <option value="cancelled">Anulat</option>
            </select>
          </div>

          <div class="form-group">
            <label for="paymentStatus">PlatÄƒ *</label>
            <select id="paymentStatus" required>
              <option value="unpaid">NeplÄƒtit</option>
              <option value="paid">PlÄƒtit</option>
              <option value="partial">ParÈ›ial</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="comments">NotiÈ›e (opÈ›ional)</label>
          <textarea id="comments" placeholder="Detalii suplimentare..."></textarea>
        </div>

        <button type="submit" class="btn" id="submitBtn">AdaugÄƒ ComandÄƒ</button>
        <button type="button" class="btn logout-btn" id="logoutBtn">Deconectare</button>
      </form>
    </div>
  </div>

  <script>
    const PASSWORD_HASH = "9a6e960876084d975bdfae1fc4e34c22db0bc51adfa5443383b8c4e67f2af831";
    const API_SECRET = "flormellow_secret_key_2025_xK9p";

    const WEBHOOK_NEW_ORDER    = "https://api.flormellow.ro/webhook/new-order";
    const WEBHOOK_ORDERS_LIST  = "https://api.flormellow.ro/webhook/orders-list";
    const WEBHOOK_ORDER_UPDATE = "https://api.flormellow.ro/webhook/order-update";

    const CATALOG_URL = "../catalog.html";

    const AUTH_KEY = "flormellow_auth_v1";
    function isAuthed(){ return sessionStorage.getItem(AUTH_KEY) === "1"; }
    function setAuthed(v){ sessionStorage.setItem(AUTH_KEY, v ? "1" : "0"); }

    const loginContainer = document.getElementById("loginContainer");
    const appContainer = document.getElementById("appContainer");

    function showLogin(){
      loginContainer.classList.remove("hidden");
      appContainer.classList.add("hidden");
    }
    function showApp(){
      loginContainer.classList.add("hidden");
      appContainer.classList.remove("hidden");
    }
    if (isAuthed()) showApp(); else showLogin();

    function showMessage(type, text){
      const el = document.getElementById(type === "success" ? "successMessage" : "errorMessage");
      el.textContent = text;
      el.style.display = "block";
      setTimeout(()=>{ el.style.display="none"; }, 4500);
    }
    function showLoginError(text){
      const el = document.getElementById("loginError");
      el.textContent = text;
      el.style.display = "block";
      setTimeout(()=>{ el.style.display="none"; }, 3200);
    }
    async function sha256hex(str){
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const p = document.getElementById("loginPassword").value;
      const hex = await sha256hex(p);
      if (hex === PASSWORD_HASH){
        setAuthed(true);
        document.getElementById("loginPassword").value = "";
        showApp();
        showMessage("success","âœ… Autentificat.");
      } else {
        showLoginError("ParolÄƒ incorectÄƒ!");
      }
    });

    function doLogout(){
      setAuthed(false);
      showLogin();
      document.getElementById("orderForm").reset();
    }
    document.getElementById("logoutBtn").addEventListener("click", doLogout);
    document.getElementById("logoutBtn2").addEventListener("click", doLogout);

    // Tabs
    const tabNew = document.getElementById("tabNew");
    const tabManage = document.getElementById("tabManage");
    const manageContainer = document.getElementById("manageContainer");
    const orderForm = document.getElementById("orderForm");

    function showNewTab(){
      orderForm.classList.remove("hidden");
      manageContainer.classList.add("hidden");
      tabNew.classList.remove("dim");
      tabManage.classList.add("dim");
    }
    function showManageTab(){
      orderForm.classList.add("hidden");
      manageContainer.classList.remove("hidden");
      tabNew.classList.add("dim");
      tabManage.classList.remove("dim");
      loadOrders();
    }
    tabNew.addEventListener("click", showNewTab);
    tabManage.addEventListener("click", showManageTab);
    showNewTab();

    // Phone formatting
    document.getElementById("clientPhone").addEventListener("input",(e)=>{
      let v = e.target.value.replace(/\D/g,'');
      if (v.length>0 && v[0]!=='0') v='0'+v;
      if (v.length>10) v=v.slice(0,10);
      e.target.value=v;
    });

    // Date defaults
    const today = new Date().toISOString().split("T")[0];
    const dd = document.getElementById("deliveryDate");
    dd.setAttribute("min", today);
    dd.value = today;

    // New order submit
    document.getElementById("orderForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      submitBtn.textContent = "Se trimite...";

      const payload = {
        secret: API_SECRET,
        client_name: document.getElementById("clientName").value.trim(),
        client_phone: document.getElementById("clientPhone").value.trim(),
        product: document.getElementById("product").value,
        size: document.getElementById("size").value,
        quantity: parseInt(document.getElementById("quantity").value, 10) || 1,
        price: parseFloat(document.getElementById("price").value),
        delivery_date: document.getElementById("deliveryDate").value,
        status: document.getElementById("status").value,
        payment_status: document.getElementById("paymentStatus").value,
        comments: document.getElementById("comments").value.trim()
      };

      try{
        const res = await fetch(WEBHOOK_NEW_ORDER, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Eroare la trimitere");
        showMessage("success","âœ… Comanda a fost adÄƒugatÄƒ!");
        document.getElementById("orderForm").reset();
        document.getElementById("status").value="pending";
        document.getElementById("paymentStatus").value="unpaid";
        dd.value = today;
      }catch(err){
        showMessage("error","âŒ " + (err?.message || "Failed to fetch"));
      }finally{
        submitBtn.disabled=false;
        submitBtn.textContent="AdaugÄƒ ComandÄƒ";
      }
    });

    // Manage list/update
    let cachedOrders = [];

    function orderCard(o){
      const safe = (x)=> (x===null||x===undefined) ? "" : String(x);
      const meta = [
        safe(o.client_name) + " â€¢ " + safe(o.client_phone),
        safe(o.product) + (o.size ? " ("+safe(o.size)+")" : "") + (o.quantity ? " Ã—"+safe(o.quantity) : ""),
        "Livrare: " + safe(o.delivery_date),
        "PreÈ›: " + safe(o.price)
      ].join("<br>");

      const statusOptions = [
        ["pending","ÃŽn AÈ™teptare"],
        ["confirmed","Confirmat"],
        ["preparing","ÃŽn PregÄƒtire"],
        ["delivered","Livrat"],
        ["cancelled","Anulat"],
      ].map(([v,txt])=> `<option value="${v}" ${safe(o.status)===v?"selected":""}>${txt}</option>`).join("");

      const payOptions = [
        ["unpaid","NeplÄƒtit"],
        ["paid","PlÄƒtit"],
        ["partial","ParÈ›ial"],
      ].map(([v,txt])=> `<option value="${v}" ${safe(o.payment_status)===v?"selected":""}>${txt}</option>`).join("");

      return `
        <div class="orderCard" data-oid="${safe(o.order_id)}">
          <div class="orderTop">
            <div>
              <div class="oid">${safe(o.order_id)}</div>
              <div class="meta">${meta}</div>
              <span class="pill">${safe(o.status)}</span>
            </div>
          </div>

          <div class="cardRow">
            <div class="form-group" style="margin-bottom:0;">
              <label style="font-size:12px;">Status</label>
              <select class="smallInput" id="st_${safe(o.order_id)}">${statusOptions}</select>
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label style="font-size:12px;">PlatÄƒ</label>
              <select class="smallInput" id="pay_${safe(o.order_id)}">${payOptions}</select>
            </div>
          </div>

          <div class="form-group" style="margin-top:10px;margin-bottom:0;">
            <label style="font-size:12px;">Comentarii</label>
            <input class="smallInput" id="cmt_${safe(o.order_id)}" value="${safe(o.comments).replace(/"/g,'&quot;')}" />
          </div>

          <div class="saveRow">
            <button class="saveBtn" data-oid="${safe(o.order_id)}">ðŸ’¾ SalveazÄƒ</button>
          </div>
        </div>
      `;
    }

    function renderOrders(orders){
      const listEl = document.getElementById("ordersList");
      if (!orders.length){
        listEl.innerHTML = '<div class="muted">Nicio comandÄƒ gÄƒsitÄƒ.</div>';
        return;
      }
      listEl.innerHTML = orders.map(orderCard).join("");

      document.querySelectorAll(".saveBtn").forEach(btn=>{
        btn.addEventListener("click", ()=> saveOrder(btn.getAttribute("data-oid")));
      });
    }

    function applyFilters(){
      const q = (document.getElementById("searchBox").value || "").trim().toLowerCase();
      const st = document.getElementById("statusFilter").value;

      const filtered = cachedOrders.filter(o=>{
        if (!st){
          if (!["pending","confirmed","preparing"].includes(String(o.status))) return false;
        } else {
          if (String(o.status) !== st) return false;
        }
        if (!q) return true;
        const hay = [o.order_id,o.client_name,o.client_phone,o.product,o.size,o.comments].join(" ").toLowerCase();
        return hay.includes(q);
      });

      renderOrders(filtered);
    }

    document.getElementById("searchBox").addEventListener("input", applyFilters);
    document.getElementById("statusFilter").addEventListener("change", applyFilters);

    async function loadOrders(){
      const listEl = document.getElementById("ordersList");
      listEl.innerHTML = '<div class="muted">Se Ã®ncarcÄƒ...</div>';

      try{
        const url = WEBHOOK_ORDERS_LIST + "?secret=" + encodeURIComponent(API_SECRET);
        const res = await fetch(url, { method:"GET" });
        if (!res.ok) throw new Error("Failed to fetch");

        const data = await res.json();
        cachedOrders = (data.orders || []);
        applyFilters();
      }catch(err){
        listEl.innerHTML = '<div class="message error" style="display:block;">Eroare la Ã®ncÄƒrcare: ' + (err?.message || "Failed to fetch") + '</div>';
      }
    }

    async function saveOrder(orderId){
      const btn = document.querySelector(`.saveBtn[data-oid="${orderId}"]`);
      if (!btn) return;

      btn.disabled = true;
      btn.textContent = "Se salveazÄƒ...";

      const payload = {
        secret: API_SECRET,
        order_id: orderId,
        status: document.getElementById(`st_${orderId}`)?.value,
        payment_status: document.getElementById(`pay_${orderId}`)?.value,
        comments: document.getElementById(`cmt_${orderId}`)?.value ?? ""
      };

      try{
        const res = await fetch(WEBHOOK_ORDER_UPDATE, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || data.ok === false) throw new Error(data.message || "Update failed");

        showMessage("success","âœ… Salvat " + orderId);
        await loadOrders();
      }catch(err){
        showMessage("error","âŒ " + (err?.message || "Update failed"));
      }finally{
        btn.disabled = false;
        btn.textContent = "ðŸ’¾ SalveazÄƒ";
      }
    }

    document.getElementById("refreshOrdersBtn").addEventListener("click", loadOrders);

    // Catalog integration
    let CATALOG_PRODUCTS = {};

    async function loadCatalogProducts(){
      try{
        const res = await fetch(CATALOG_URL, { cache:"no-store" });
        if (!res.ok) throw new Error("Cannot load catalog");
        const text = await res.text();
        const doc = new DOMParser().parseFromString(text, "text/html");
        const cards = Array.from(doc.querySelectorAll("article.product-card"));

        const items = [];
        for (const card of cards){
          const name = (card.getAttribute("data-title") || card.dataset.title || "").trim();
          if (!name) continue;
          const img = (card.getAttribute("data-img") || card.dataset.img || (card.querySelector("img")?.getAttribute("src") || "")).trim();
          const size = (card.getAttribute("data-size") || card.dataset.size || "").trim();
          const price = (card.getAttribute("data-price") || card.dataset.price || "").trim();
          if (!CATALOG_PRODUCTS[name]){
            CATALOG_PRODUCTS[name] = { img, size, price };
            items.push(name);
          }
        }

        const sel = document.getElementById("product");
        const current = sel.value;

        let placeholder = sel.querySelector('option[value=""]');
        if (!placeholder){
          placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "SelecteazÄƒ produsul...";
        }

        sel.innerHTML = "";
        sel.appendChild(placeholder);

        items.sort((a,b)=>a.localeCompare(b, "ro", {sensitivity:"base"}));
        for (const name of items){
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }

        const optOther = document.createElement("option");
        optOther.value = "Altele";
        optOther.textContent = "Altele";
        sel.appendChild(optOther);

        if (current) sel.value = current;

      }catch(e){
        console.warn("Catalog integration disabled:", e);
      }
    }

    function updateProductPreview(){
      const name = document.getElementById("product").value;
      const box = document.getElementById("productPreview");
      const imgEl = document.getElementById("productPreviewImg");
      const nameEl = document.getElementById("productPreviewName");
      const metaEl = document.getElementById("productPreviewMeta");

      if (!name || name === "Altele" || !CATALOG_PRODUCTS[name]){
        box.style.display="none";
        imgEl.src=""; imgEl.alt="";
        nameEl.textContent=""; metaEl.textContent="";
        return;
      }

      const p = CATALOG_PRODUCTS[name];
      const imgPath = p.img || "";
      const normalized = imgPath.startsWith("http") ? imgPath : ("../" + imgPath.replace(/^\/+/, ""));
      imgEl.src = normalized;
      imgEl.alt = name;
      nameEl.textContent = name;

      const bits = [];
      if (p.size) bits.push("MÄƒrime catalog: " + p.size);
      if (p.price) bits.push("PreÈ› catalog: " + p.price + " RON");
      metaEl.textContent = bits.join(" â€¢ ");
      box.style.display="block";
    }

    document.getElementById("product").addEventListener("change", updateProductPreview);
    loadCatalogProducts().then(updateProductPreview);
  </script>
</body>
</html>
